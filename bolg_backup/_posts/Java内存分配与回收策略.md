---
layout: post
title: Java内存分配与回收策略
data: 2017/5/11
subtitle: ""
description: ""
thumbnail: "/img/jvm/内存分配策略.jpg"
tags:
  - Java#JVM
categories:
  - Java
---
# 内存分配与回收策略

## 目录

* 对象优先在Eden分配
* 大对象直接进入老年代
* 长期存活对象将进入老年代
* 动态对象年龄判定
* 空间分配担保

### 对象优先在Eden分配

* 大多数情况下, 对象主要分配在新生代的Eden区上.
* 当Eden区没有足够的空间进行分配时, 虚拟机将进行一次 Minor GC

### 大对象直接进入老年代

* 大对象指的是需要大量连续内存空间的Java对象,最典型的大对象就是那种很长的字符串以及数组.
* 经常出现大对象容易导致内存还有不少空间时就提前触发垃圾收集以获取足够的连续空间来"安置"他们.

### 长期存活的对象将进入老年代

* 为了采用分代收集来管理内存,虚拟机给每个对象定义了一个对象年龄计数器.
* 如果对象在Eden出生并经历第一次Minor GC后仍然存活, 并且能被Survivor容纳的话,将被移动到Survivor,并且年龄就增加1岁.
* 当它的年龄增加到一定程度(默认为15岁),就会被晋升到老年代.

### 动态对象年龄判断

* 如果在Survivor空间中相同年龄所有对象大小的总和大于Survivor空间的一半, 年龄大于或者等于该年龄的对象就可以直接进入老年代,无需等到MaxTenuringThreshold2中要求的年龄.

### 空间分配担保

* 如果老年代最大可用连续空间大于新生代所有对象总空间,那么Minor GC可以确保是安全的.
* 如果老年代最大可用连续空间不大于新生代所有对象总空间的话且老年代最大可用连续空间是大于历次晋升到老年代对象的平均大小,那么Minor GC是冒险的.
* 如果老年代最大可用连续空间不大于新生代所有对象总空间的话且老年代最大可用连续空间是小于历次晋升到老年代对象的平均大小,那这时要进行一次Full GC.

> 参考资料：《深入理解Java虚拟机》
